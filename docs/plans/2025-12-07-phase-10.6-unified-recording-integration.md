# Phase 10.6: Unified Recording Integration

**Date**: December 7, 2025
**Status**: Ready for Implementation
**Branch**: `feat/issue-1-human-demo-recording`

---

## 1. Problem Statement

Two separate recording systems exist:

| System | Component | Status |
|--------|-----------|--------|
| OLD | `DemoRecorderSink` | Working, receives UI button presses |
| NEW | `UnifiedRecorder` | Built, but never receives player actions |

**Gap**: TradingController calls `DemoRecorderSink`, not `UnifiedRecorder`.

---

## 2. Design Decisions (From Brainstorming)

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Button capture | ALL presses | Full human behavior for imitation learning |
| State capture | Local + Server | Validation that REPLAYER matches real game |
| Drift tolerance | Zero | Any difference = bug to fix |
| Recording trigger | Automatic on connect | Hands-off, captures everything |
| Filename format | `YYYYMMDD_HHMMSS_gameId.json` | Simple, chronological |
| Server seeds | ALWAYS in file | Critical for authenticity/verification |

---

## 3. Target Architecture

```
UI Button Click (BUY, SELL, +0.01, 25%, etc.)
    │
    ▼
TradingController._record_button_press()
    │
    ▼
RecordingController.on_button_press(button, amount, state)
    │
    ▼
UnifiedRecorder.record_action(action_with_validation)
    │
    ├──► games/YYYYMMDD_HHMMSS_gameId.json
    │        - prices[], peak, duration, server_seed, server_seed_hash
    │
    └──► player/YYYYMMDD_HHMMSS_gameId_player.json
             - all button presses
             - local_state + server_state per action
             - drift_detected flag
```

---

## 4. Data Model Changes

### 4.1 Enhanced PlayerAction (captures ALL button types)

```python
@dataclass
class RecordedAction:
    """Single recorded action with full validation context."""

    # Identity
    action_id: str
    game_id: str
    tick: int
    timestamp: datetime

    # Action details
    category: str  # BET_INCREMENT, SELL_PERCENTAGE, TRADE_BUY, TRADE_SELL, TRADE_SIDEBET
    button: str    # Exact button text: "BUY", "+0.01", "25%", etc.
    amount: Optional[Decimal]  # For trades

    # Dual-state validation
    local_state: StateSnapshot   # REPLAYER's calculations
    server_state: ServerState    # WebSocket playerUpdate data
    drift_detected: bool
    drift_details: Optional[dict]  # What differed, by how much

    # Timing
    latency_ms: Optional[float]  # Button press → server confirmation
```

### 4.2 StateSnapshot (local calculations)

```python
@dataclass
class StateSnapshot:
    """REPLAYER's calculated state at action time."""
    balance: Decimal
    position_qty: Decimal
    position_entry_price: Optional[Decimal]
    position_pnl: Optional[Decimal]
    sidebet_active: bool
    sidebet_amount: Optional[Decimal]
    bet_amount: Decimal
    sell_percentage: Decimal
    current_tick: int
    current_price: Decimal
    phase: str
```

### 4.3 ServerState (WebSocket truth)

```python
@dataclass
class ServerState:
    """Server-reported state from playerUpdate WebSocket event."""
    cash: Decimal
    position_qty: Decimal
    avg_cost: Decimal
    cumulative_pnl: Decimal
    total_invested: Decimal
    timestamp: float
```

---

## 5. Component Changes

### 5.1 UnifiedRecorder - Add button recording

**File**: `services/unified_recorder.py`

Add method:
```python
def record_button_press(
    self,
    button: str,
    amount: Optional[Decimal],
    local_state: StateSnapshot,
    server_state: Optional[ServerState]
) -> None:
    """Record any button press with validation."""
```

Merge in from DemoRecorderSink:
- Action categorization (BET_INCREMENT, SELL_PERCENTAGE, TRADE_*)
- Latency tracking for trade confirmations
- JSONL buffering and flush logic

### 5.2 RecordingController - Add button handler

**File**: `ui/controllers/recording_controller.py`

Add method:
```python
def on_button_press(
    self,
    button: str,
    amount: Optional[Decimal] = None
) -> None:
    """Handle button press from TradingController."""
```

Wire to UnifiedRecorder.record_button_press()

### 5.3 TradingController - Redirect to new system

**File**: `ui/controllers/trading_controller.py`

Change:
```python
# OLD
self.demo_recorder.record_button_press(...)

# NEW
self.recording_controller.on_button_press(...)
```

Add: Capture server_state from last WebSocket playerUpdate

### 5.4 LiveFeedController - Auto-start recording

**File**: `ui/controllers/live_feed_controller.py`

On WebSocket connect:
```python
self.recording_controller.start_session()
```

On WebSocket disconnect:
```python
self.recording_controller.stop_session()
```

---

## 6. File Format

### 6.1 Game State File

**Path**: `rugs_recordings/games/YYYYMMDD_HHMMSS_gameId.json`

```json
{
  "meta": {
    "game_id": "abc123def456",
    "start_time": "2025-12-07T14:30:52.123Z",
    "end_time": "2025-12-07T14:32:15.456Z",
    "duration_ticks": 138,
    "peak_multiplier": "2.45",
    "server_seed_hash": "a3f8c2d1e5b7f9a0c3d2e1f4a5b6c7d8",
    "server_seed": "revealed_seed_after_rug"
  },
  "prices": ["1.0", "1.01", "1.03", "1.02", ...]
}
```

### 6.2 Player Action File

**Path**: `rugs_recordings/player/YYYYMMDD_HHMMSS_gameId_player.jsonl`

```jsonl
{"type":"action","action_id":"uuid","tick":45,"button":"+0.01","category":"BET_INCREMENT","local_state":{...},"server_state":{...},"drift_detected":false}
{"type":"action","action_id":"uuid","tick":47,"button":"BUY","category":"TRADE_BUY","amount":"0.005","local_state":{...},"server_state":{...},"drift_detected":false,"latency_ms":125}
{"type":"action","action_id":"uuid","tick":89,"button":"25%","category":"SELL_PERCENTAGE","local_state":{...},"server_state":{...},"drift_detected":true,"drift_details":{"field":"balance","local":"0.995","server":"0.994999","diff":"0.000001"}}
{"type":"action","action_id":"uuid","tick":92,"button":"SELL","category":"TRADE_SELL","amount":"0.00125","local_state":{...},"server_state":{...},"drift_detected":false,"latency_ms":118}
```

---

## 7. Migration Path

### Phase 1: Add new functionality (non-breaking)
1. Add `record_button_press()` to UnifiedRecorder
2. Add `on_button_press()` to RecordingController
3. Add ServerState capture to TradingController
4. Wire LiveFeedController auto-start/stop

### Phase 2: Switch over
5. Change TradingController to call RecordingController
6. Verify recordings work end-to-end

### Phase 3: Cleanup
7. Remove DemoRecorderSink from MainWindow
8. Remove demo_recorder parameter from TradingController
9. Delete `core/demo_recorder.py` (or keep as reference)
10. Update tests

---

## 8. Success Criteria

- [ ] All button presses recorded (BUY, SELL, SIDEBET, percentages, increments)
- [ ] Local state captured with each action
- [ ] Server state captured with each action
- [ ] Zero-tolerance drift detection working
- [ ] Server seed + hash ALWAYS in game files
- [ ] Recording auto-starts on WebSocket connect
- [ ] Recording auto-stops on WebSocket disconnect
- [ ] DemoRecorderSink removed from codebase
- [ ] All existing tests pass
- [ ] New tests cover validation layer

---

*Design Complete - Ready for Implementation*
