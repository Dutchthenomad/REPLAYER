# Phase 10.5 Implementation Handoff Prompt

**Copy everything below the line into a fresh Claude Code session.**

---

## Session Context

I'm continuing implementation of the REPLAYER project - a dual-mode game viewer for Rugs.fun that records gameplay data for ML/RL training.

**Project Location**: `/home/nomad/Desktop/REPLAYER/src`
**Branch**: `feat/issue-1-human-demo-recording`

### Previous Work Completed
- **Phase 10.1-10.3**: Demo recording models, TradingController integration, MainWindow menu
- **Phase 10.4**: WebSocket Foundation Layer (124 tests passing)
  - Modular refactor of websocket_feed.py
  - PlayerStateHandler, PriceHistoryHandler, StateVerifier
  - GameStateRecorder, PlayerSessionRecorder
  - Recording data models

### Current Task: Phase 10.5 - Unified Recording Configuration System

**Design Document**: `docs/plans/2025-12-07-unified-recording-config-design.md`

Read this design document first - it contains the complete specification for what we're building.

## Implementation Requirements

### What We're Building
A unified recording configuration system with:
1. **Config Modal UI** - Appears when user selects "Start Recording" from menu
2. **Recording State Machine** - IDLE → MONITORING → RECORDING → FINISHING_GAME
3. **Data Integrity Monitor** - Detects data loss, triggers monitor mode
4. **Unified Recorder** - Orchestrates game state + player state recording
5. **Toast Notifications** - Visual feedback for recording state changes
6. **Audio Cues** - Sound feedback (optional, toggleable)
7. **Config Persistence** - Save/load settings to JSON

### Key Design Decisions (Non-Negotiable)
1. **No partial captures** - Games recorded start-to-end or not at all
2. **Clean start** - Ignore in-progress game, wait for next fresh game
3. **Clean stop** - Finish current game when limit reached, then stop
4. **Monitor mode** - Pause on data integrity issues, resume after clean game observed
5. **Dual-layer architecture** - Game state (always) + Player state (optional)
6. **First limit wins** - Game count OR time limit, whichever is reached first

### File Organization
```
rugs_recordings/
├── games/              # All game state recordings (has_player_input flag)
└── demonstrations/     # Player state recordings (when enabled)
```

## Development Methodology

**This project uses Superpowers TDD methodology. The 5 Iron Laws:**

| Principle | Command | Rule |
|-----------|---------|------|
| TDD | `/tdd` | NO code without failing test first |
| Verification | `/verify` | Evidence before claims |
| Debugging | `/debug` | 4-phase root cause analysis |
| Planning | `/plan` | Zero-context executable plans |
| Isolation | `/worktree` | Isolated workspace per feature |

### Test Command
```bash
cd /home/nomad/Desktop/REPLAYER/src
/home/nomad/Desktop/rugs-rl-bot/.venv/bin/python -m pytest tests/ -v --tb=short
```

### Implementation Order (TDD for each)

**Phase 10.5A: Config Model & Persistence**
- Create `models/recording_config.py` with `RecordingConfig` dataclass
- Implement load/save to JSON
- Test file: `tests/test_models/test_recording_config.py`

**Phase 10.5B: Recording State Machine**
- Create `services/recording_state_machine.py`
- States: IDLE, MONITORING, RECORDING, FINISHING_GAME
- Test file: `tests/test_services/test_recording_state_machine.py`

**Phase 10.5C: Data Integrity Monitor**
- Create `services/data_integrity_monitor.py`
- Track consecutive data loss (ticks OR games - mutually exclusive)
- Test file: `tests/test_services/test_data_integrity_monitor.py`

**Phase 10.5D: Unified Recorder**
- Create `services/unified_recorder.py`
- Orchestrates GameStateRecorder + PlayerSessionRecorder
- Test file: `tests/test_services/test_unified_recorder.py`

**Phase 10.5E: Config Modal UI**
- Create `ui/recording_config_dialog.py`
- Tkinter Toplevel modal with all controls per design
- Test file: `tests/test_ui/test_recording_config_dialog.py`

**Phase 10.5F: Toast Notifications**
- Create `ui/toast_notification.py`
- Test file: `tests/test_ui/test_toast_notification.py`

**Phase 10.5G: Audio Cues**
- Create `services/audio_cue_player.py`
- Test file: `tests/test_services/test_audio_cue_player.py`

**Phase 10.5H: Integration**
- Wire all components together
- Update MainWindow menu to open config dialog
- End-to-end testing

## Key Files to Reference

### Phase 10.4 Components (already built)
- `services/recorders.py` - GameStateRecorder, PlayerSessionRecorder
- `sources/player_state_handler.py` - Player WebSocket events
- `sources/price_history_handler.py` - Tick tracking
- `services/state_verifier.py` - State drift detection
- `models/recording_models.py` - Data models

### Existing UI
- `ui/main_window.py` - Main application window (has Recording menu)

### Design Document
- `docs/plans/2025-12-07-unified-recording-config-design.md` - **READ THIS FIRST**

## Starting Instructions

1. Read the design document: `docs/plans/2025-12-07-unified-recording-config-design.md`
2. Run existing tests to confirm baseline: `cd src && /home/nomad/Desktop/rugs-rl-bot/.venv/bin/python -m pytest tests/ -v --tb=short -x`
3. Start with Phase 10.5A (Config Model) using TDD:
   - Write tests FIRST
   - Run tests (expect RED - fail)
   - Implement code
   - Run tests (expect GREEN - pass)
4. Proceed through phases in order (A → B → C → D → E → F → G → H)
5. Use TodoWrite to track progress through each phase

## Success Criteria

By end of Phase 10.5:
- [ ] Config modal appears on "Start Recording" menu selection
- [ ] All settings persist correctly across sessions
- [ ] Auto-start on launch works when enabled
- [ ] No partial games ever saved
- [ ] Clean start/stop behavior working
- [ ] Monitor mode triggers and recovers correctly
- [ ] Toast notifications display for recording events
- [ ] Audio cues play when enabled
- [ ] Dual-layer recording works (game + player state)
- [ ] Files organized in games/ and demonstrations/
- [ ] `has_player_input` flag set correctly
- [ ] All tests passing

Begin by reading the design document and confirming you understand the requirements.
